---
layout: post
title: Express分页
---

{{ page.title }}
================

安装
---------------------------
首先安装 mongoose
	$ npm install mongoose

案例
--------------
建一个models文件，在这里面写入表的模型 和 建立数据库连接

	var mongoose = require('mongoose'),
	    Schema = mongoose.Schema,
	    User = new Schema({
		email: String,
		name: String
	    });
	    
	mongoose.connect('mongodb://localhost/emailName');
	    
	exports.User = mongoose.model('User', User);

app.js里面 加入此模块，定义模型变量

	var mondels = require('./mondels');
	var User = mondels.User;


app.js 添加 路由 和 操作

	app.get('/add',function (req, res) {
	    
	    // 加入数据
	    
	    var i,
		len = 100,
		user;
		
	    for (i = 0; i < len; i += 1) {
		user = new User({
		    email: i + '@qq.com',
		    name: 'freewind-' + i
		});
		user.save();
	    }
	    
	    
	    res.send('数据加入成功了！！');
	});

	var totalPageNum,
	    onePageNum = 10;

	app.get('/list/:id',

	function (req, res, next) {
	    
	    // 获得总页数
	    
	    User.find({}, function (err, items) {
		totalPageNum = Math.ceil(items.length / onePageNum);
		next();
	    });
	},


	 function (req, res) {
	     
	   // 输出分页数据
	    
	   var currentPageNum = parseInt(req.params.id);
	   
	   if (currentPageNum < 1) {
	       currentPageNum = 1;
	   }
	   
	   if (currentPageNum > totalPageNum) {
	      currentPageNum = totalPageNum; 
	   }

	   User
	    .find({})
	    .skip((currentPageNum - 1) * onePageNum)  
	    .limit(onePageNum)
	   .exec(function (err, items) {
	      res.set('Content-Type', 'text/html');
		
		var i,
		    len = items.length,
		    str = '';
		    
		for (i = 0; i < len; i += 1) {
		    str += '<h2>' + items[i].name + '</h2>';
		    str += '<p>' + items[i].email + '</p>';
		}
		
		 str += '<p><a href="/list/' + (currentPageNum - 1) + 
        '">上一页</a> <a href="/list/' + (currentPageNum + 1) + 
        '">下一页</a> ' + currentPageNum + '/' + totalPageNum  + '</p>';
		
		  res.send(str);
	   });   
	   
	 
	});

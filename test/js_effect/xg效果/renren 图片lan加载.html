HeadLazyload = function(){
    var This = this,timer = null;
    function loader(force){
        if (timer)  return;
        timer = setTimeout(function(){
            This._loadImgs(force);
            timer = null;
        }, 100); 
    }
    this.images = [];
    this.DATA_SRC = 'lazyload-src';
    this.diff = 100;
    this.threshold = this._getThreshold()
    XN.event.addEvent(window, 'scroll',loader);
    XN.event.addEvent(window, 'resize',function(){
        This.threshold = This._getThreshold();
        loader(true);
    });       
}
HeadLazyload.prototype = {
    init : function(diff){
        this.images = [];
        this.diff = diff || 100;    
    },
    addContainer : function(container){
        var imgs = container.getElementsByTagName("img");
        var img = null,data_src=null,ret = this.images,_dataSrc = this.DATA_SRC;
        for(var i = 0;img = imgs[i++];){
            data_src = img.getAttribute(_dataSrc);
            if (data_src)  ret.push(img);
        }
        var This = this;
        setTimeout(function(){This._loadImgs(true);},100)
        
    },
    _loadImgs : function(force){
        var scrollTop = this._getScroll();
        if(!force && scrollTop <= this.diff) return;
        var imgs = this.images,remain = [], threshold = this.threshold + scrollTop, img = null,data_src=null;
        var _dataSrc = this.DATA_SRC;
        for(var i = 0;img = imgs[i++];){
            var t = $(img).realTop()
            if(t <= threshold && t > scrollTop ){
                data_src = img.getAttribute(_dataSrc);
                if(data_src && img.src != data_src) {
                        img.src = data_src;
                        img.removeAttribute(_dataSrc);
                }
            }else{
                remain.push(img);
            }
        }
        this.images = remain;
    },
    _getThreshold: function() {     
       var height = self.innerHeight, mode = document['compatMode'];
       var isIE = XN.Browser.IE, isOpera = XN.Browser.Opera;     
       if ( (mode || isIE) && !isOpera ) { // IE, Gecko
                height = (mode == 'CSS1Compat') ?
                        document.documentElement.clientHeight : // Standards
                        document.body.clientHeight; // Quirks
            }
        return height;
    },
    _getScroll : function(){
         return Math.max(document['documentElement'].scrollTop, document.body.scrollTop);
    }
}

